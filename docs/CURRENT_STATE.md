# Parker BOS â€” Codebase Audit (February 2026)

Generated by exhaustive read of every source file in `src/`. Last updated: 2026-02-25.

---

## Table of Contents
1. [Stack & Runtime](#1-stack--runtime)
2. [npm Packages](#2-npm-packages)
3. [Pages / Routes](#3-pages--routes)
4. [Components](#4-components)
5. [Firestore Collections & Fields](#5-firestore-collections--fields)
6. [TypeScript Types & Interfaces](#6-typescript-types--interfaces)
7. [Library Files & Utilities](#7-library-files--utilities)
8. [Flagged Inconsistencies & Bugs](#8-flagged-inconsistencies--bugs)

---

## 1. Stack & Runtime

| Layer | Version |
|-------|---------|
| Next.js | 16.1.6 (App Router) |
| React | 19.2.3 |
| TypeScript | ^5 |
| Tailwind CSS | ^4 (PostCSS plugin mode) |
| Firebase SDK | ^12.8.0 |
| Node | ^20 (types) |

Firebase products in use: **Firestore**, **Auth**, **Storage**, **Analytics** (optional).

---

## 2. npm Packages

### Dependencies (runtime)

| Package | Version | Actually Used? |
|---------|---------|----------------|
| `next` | 16.1.6 | Yes |
| `react` | 19.2.3 | Yes |
| `react-dom` | 19.2.3 | Yes |
| `firebase` | ^12.8.0 | Yes â€” Auth, Firestore, Storage, Analytics |
| `@anthropic-ai/sdk` | ^0.75.0 | **NO** â€” installed but the API route calls Anthropic via raw `fetch()`, not via this SDK |
| `@hookform/resolvers` | ^5.2.2 | Yes â€” used in `ChangeOrderForm` and `FieldChangeOrderForm` |
| `react-hook-form` | ^7.71.1 | Yes â€” used in `ChangeOrderForm` and `FieldChangeOrderForm` |
| `zod` | ^4.3.6 | Yes â€” used in `ChangeOrderForm` and `FieldChangeOrderForm` for schema validation |

### Dev Dependencies

| Package | Version |
|---------|---------|
| `@tailwindcss/postcss` | ^4 |
| `@types/node` | ^20 |
| `@types/react` | ^19 |
| `@types/react-dom` | ^19 |
| `eslint` | ^9 |
| `eslint-config-next` | 16.1.6 |
| `tailwindcss` | ^4 |
| `typescript` | ^5 |

---

## 3. Pages / Routes

### App Router Pages (`src/app/`)

| Route | File | Description |
|-------|------|-------------|
| `/` | `app/page.tsx` | Root â€” likely redirect to `/dashboard` |
| `/login` | `app/login/page.tsx` | Firebase Auth login: email/password + Google Sign-In. Redirects to `/dashboard` when authenticated. |
| `/dashboard` | `app/dashboard/page.tsx` | Stat cards: Active Jobs count, Awarded Jobs count, COs Pending Review count, Total Approved CO Value. Module grid linking to main sections. |
| `/jobs` | `app/jobs/page.tsx` | Jobs list table with phase filter tabs (All, Lead, Bidding, Opportunity, Awarded, Active, Install, Warranty, Closed, Lost), text search, delete. |
| `/jobs/new` | `app/jobs/new/page.tsx` | Renders `<JobForm>` for new job creation. |
| `/jobs/[id]` | `app/jobs/[id]/page.tsx` | Job detail: contract info, site info, team (with clickable contact modals), activity log (add notes with tag), file manager (phase+category tabs), budget table (if Awarded/Active/Install). |
| `/jobs/[id]/edit` | `app/jobs/[id]/edit/page.tsx` | Renders `<JobForm>` pre-populated with existing job data. |
| `/project-management` | `app/project-management/page.tsx` | Per-job cards for Awarded/Active/Install jobs. Inline editing of `completedPct`, `actualHours`, `actualMaterials`, `notes` on `costingPhases` rows. Collapse/expand cards individually. Collapse All / Expand All. Budget re-import button. |
| `/change-orders` | `app/change-orders/page.tsx` | CO list table with status filter and search. Summary cards. Submit Draftâ†’Submitted. Opens `<ChangeOrderReview>` modal on CO number click. |
| `/change-orders/new` | `app/change-orders/new/page.tsx` | Renders `<ChangeOrderForm>` (office/internal CO). |
| `/change-orders/field/new` | `app/change-orders/field/new/page.tsx` | Renders `<FieldChangeOrderForm>` (simplified field CO). |
| `/estimates` | `app/estimates/page.tsx` | Estimates list: shows both install and construction estimates from the shared `estimates` collection. Filter tabs (All, Draft, Opportunity, Awarded, Lost). Dropdown to create Install or Construction estimate. |
| `/estimates/new` | `app/estimates/new/page.tsx` | Renders `<EstimateBuilder>` with no estimateId (new install estimate). |
| `/estimates/[id]` | `app/estimates/[id]/page.tsx` | Renders `<EstimateBuilder>` with existing estimateId (edit install estimate). |
| `/estimates/construction/new` | `app/estimates/construction/new/page.tsx` | Renders `<ConstructionEstimateBuilder>` for a new construction estimate. |
| `/estimates/construction/[id]` | `app/estimates/construction/[id]/page.tsx` | Renders `<ConstructionEstimateBuilder>` for an existing construction estimate. |
| `/companies` | `app/companies/page.tsx` | Companies list with type filter tabs, tag filter pills, text search. Inline type editing (click badge â†’ dropdown). Inline tag management (add/remove tags). Delete. |
| `/companies/new` | `app/companies/new/page.tsx` | Renders `<CompanyForm>` for new company. |
| `/companies/[id]` | `app/companies/[id]/page.tsx` | Company detail: info card + list of linked contacts (queried by `companyId`). |
| `/companies/[id]/edit` | `app/companies/[id]/edit/page.tsx` | Renders `<CompanyForm>` pre-populated. |
| `/contacts` | `app/contacts/page.tsx` | Contacts list with text search. Shows linked company as clickable link. Phone formatted via `formatPhoneDisplay`. Delete. |
| `/contacts/new` | `app/contacts/new/page.tsx` | Renders `<ContactForm>` for new contact. |
| `/contacts/[id]` | `app/contacts/[id]/page.tsx` | Contact detail: all fields, linked company link. |
| `/contacts/[id]/edit` | `app/contacts/[id]/edit/page.tsx` | Renders `<ContactForm>` pre-populated. |
| `/employees` | `app/employees/page.tsx` | Employees list with role filter tabs, text search. |
| `/employees/new` | `app/employees/new/page.tsx` | Renders `<EmployeeForm>` for new employee. |
| `/employees/[id]` | `app/employees/[id]/page.tsx` | Employee detail. |
| `/employees/[id]/edit` | `app/employees/[id]/edit/page.tsx` | Renders `<EmployeeForm>` pre-populated. |
| `/jurisdictions` | `app/jurisdictions/page.tsx` | Jurisdictions list, text search, delete. |
| `/jurisdictions/new` | `app/jurisdictions/new/page.tsx` | Renders `<JurisdictionForm>` for new jurisdiction. |
| `/jurisdictions/[id]` | `app/jurisdictions/[id]/page.tsx` | Jurisdiction detail: info, linked contacts (fetched by IDs in `contactIds` array). |
| `/jurisdictions/[id]/edit` | `app/jurisdictions/[id]/edit/page.tsx` | Renders `<JurisdictionForm>` pre-populated. |
| `/files` | `app/files/page.tsx` | Global file manager: shows all docs from `files` collection, filtered by entityType (job/employee/other). Bulk delete (deletes from Firebase Storage + Firestore). |
| `/settings` | `app/settings/page.tsx` | Cost code management: inline edit code/label, reorder with up/down arrows, delete. Auto-seeds 12 codes if collection is empty. |
| `/import` | `app/import/page.tsx` | Hardcoded Airtable data import tool. Writes to `Jobs`, `companies`, `contacts`, `jurisdictions`, `employees`. Upserts by matching on name/email. Massive file with 1500+ lines of hardcoded data. |

### API Routes

| Route | File | Description |
|-------|------|-------------|
| `POST /api/enhance-description` | `app/api/enhance-description/route.ts` | Takes `{ description: string }`, calls Anthropic API (`claude-sonnet-4-20250514`) via raw `fetch()`, returns `{ enhanced: string }`. Used by CO forms to improve field note descriptions. |

---

## 4. Components

### `src/components/AppShell.tsx`
Layout wrapper for all authenticated pages. Contains:
- Left sidebar nav with expandable "Jobs" submenu (`All Jobs`, `Project Management`, `Estimates`, `Change Orders`)
- Full nav: Dashboard, Jobs (expandable), Companies, Contacts, Employees, Jurisdictions, Purchase Orders (comingSoon), Files, Settings
- Firebase Auth check via `onAuthStateChanged` â€” redirects to `/login` if unauthenticated
- Sign out button

### `src/components/EstimateBuilder.tsx`
Full install estimate builder. Features:
- Lazy creates estimate doc on first "Add Line"; updates URL via `window.history.replaceState`
- Job typeahead (searches `Jobs` collection)
- GC company typeahead (searches `companies` collection)
- Estimator typeahead (searches `contacts` collection)
- Line items table with add/delete; inline edits save on blur
- Rate controls: laborRate, laborBurden, materialMarkup
- Margin display (color-coded: green â‰¥30%, amber â‰¥15%, red <15%)
- Status transitions: Draft â†’ Opportunity, Draft/Opportunity â†’ Awarded (creates `costingPhases` docs + updates linked job to "Awarded"), â†’ Lost
- "Mark Awarded": groups lines by costCode â†’ creates `costingPhases` docs â†’ optionally creates new `Jobs` doc
- Copy QBO description (clipboard)
- Delete estimate (deletes all `estimateLines` + estimate doc)
- Reads from: `estimates`, `estimateLines`, `costCodes`, `Jobs`, `companies`, `contacts`
- Writes to: `estimates`, `estimateLines`, `costingPhases`, `Jobs`

### `src/components/ConstructionEstimateBuilder.tsx`
Construction estimate builder. Features:
- TSV paste for phases (same format as BudgetImport)
- Fixture list paste (from Excel/Sheets)
- Phase table with inline add/edit
- Fixture table with inline add/edit
- Scope of work, exclusions, clarifications fields (rich-text via `contentEditable`, stored as HTML)
- Reads from: `estimates`, `constructionEstimatePhases`, `constructionFixtures`, `Jobs`, `companies`, `contacts`
- Writes to: `estimates`, `constructionEstimatePhases`, `constructionFixtures`

### `src/components/ChangeOrderForm.tsx`
Office change order creation form. Uses `react-hook-form` + `zod`. Features:
- Job search typeahead (queries `Jobs` where `projectPhase in ["Active", "Awarded"]`)
- Cost fields: laborHours, materialCost, equipmentCost, subcontractorCost, otherCost
- Rate fields: laborBurden, laborBillingRate, materialMarkup, subMarkup
- Computed amounts displayed in real-time
- AI description enhancement (calls `/api/enhance-description`)
- Auto-generates `coNumber` (CO-01, CO-02, ...) by counting existing COs for the job
- Reads from: `Jobs`, `changeOrders`
- Writes to: `changeOrders`

### `src/components/FieldChangeOrderForm.tsx`
Simplified field CO form. Uses `react-hook-form` + `zod`. Features:
- Job search (queries `Jobs` where `projectPhase == "Active"`)
- Simpler cost entry (fewer fields than office form)
- AI description enhancement
- Auto-generates `coNumber`
- Reads from: `Jobs`, `changeOrders`
- Writes to: `changeOrders`

### `src/components/ChangeOrderReview.tsx`
Modal for reviewing a CO. Features:
- Fetches CO by ID, auto-transitions `Submitted â†’ Under Review`
- Editable labor/material rate fields (when status is Submitted or Under Review)
- Approve: sets `status: "Approved"`, stores `amountApproved`, `approvedBy`, `approvedByName`, `approvedAt`; creates `costingPhases` doc (subgrouping: "CHANGE ORDER")
- Reject: sets `status: "Rejected"`, stores `rejectionReason`, `rejectedAt`
- Delete: removes CO doc + any linked `costingPhases` docs (queries by `coId`)
- Reads from: `changeOrders`, `costingPhases`
- Writes to: `changeOrders`, `costingPhases`
- Deletes from: `changeOrders`, `costingPhases`

### `src/components/BudgetImport.tsx`
TSV paste modal for importing budget data into `costingPhases`. Features:
- Paste area parses via `parseBudgetTSV()` with live label resolution from `costCodes` collection
- Diff preview against existing `costingPhases` (shows new, changed, unchanged rows)
- On confirm: deletes all existing `costingPhases` for the job, writes new ones
- Reads from: `costCodes`, `costingPhases`
- Writes/deletes to: `costingPhases`

### `src/components/JobForm.tsx`
New/edit job form. Fields: jobName, projectPhase, gcId/gcName (ContactPicker), jurisdictionId/jurisdictionName (ContactPicker), siteAddress/City/State/Zip, originalContractValue, parcelNumber, bidDueDate, estimator/pm/superintendent (each with id+name via ContactPicker).
- `PHASES_WITH_BID_DUE`: Lead, Bidding (show bid due date field)
- `PHASES_WITH_PARCEL`: Awarded, Active, Install, Warranty, Closed (show parcel number field)
- Reads from: `companies`, `jurisdictions`
- Writes to: `Jobs`

### `src/components/ContactForm.tsx`
New/edit contact form. Fields: firstName, lastName, companyId/companyName (CompanyPicker), title, phone, email.
- Writes to: `contacts`

### `src/components/CompanyForm.tsx`
New/edit company form. Fields: name, type, phone, email, address, city, state, zip, website.
- Writes to: `companies`

### `src/components/JurisdictionForm.tsx`
New/edit jurisdiction form. Fields: name, state, phone, inspectionPhone, address, website, notes, contactIds (multi-picker).
- Writes to: `jurisdictions`

### `src/components/EmployeeForm.tsx`
New/edit employee form. Fields: firstName, lastName, role, status, phone, email, emailPersonal, homeAddress, deviceNumber, partnerName/Phone/Email, emergencyContact1/Phone, emergencyContact2/Phone, birthday, hireDate, licenseId, licPlumbing, expPlumbing, licScissorLift, expGas, licGas.
- Writes to: `employees`

### `src/components/ContactPicker.tsx`
Single-select typeahead that searches across both `companies` and `contacts` collections. Returns `{ id, name }`. Used in `JobForm` for GC, jurisdiction, estimator, PM, superintendent.

### `src/components/ContactMultiPicker.tsx`
Multi-select version of ContactPicker. Used in `JurisdictionForm` for `contactIds`.

### `src/components/ContactDetailModal.tsx`
Modal showing full contact or company details. Triggered from job detail page when clicking team member names.
- Reads from: `contacts` or `companies` by ID

### `src/components/CompanyPicker.tsx`
Single-select typeahead for companies. Used in `ContactForm`.

### `src/components/FileList.tsx`
Displays uploaded files for a given `entityType + entityId + category`. Queries `files` collection with `where("entityType", "==", entityType)` and `where("entityId", "==", entityId)`. Shows download link, file size, thumbnail for images.

### `src/components/FileUpload.tsx`
Upload UI: file input â†’ uploads to Firebase Storage under path `{entityType}/{entityId}/{category}/{filename}` â†’ writes doc to `files` collection.

### `src/components/FileThumbnail.tsx`
Image preview thumbnail for image files (checks `contentType.startsWith("image/")`).

### `src/components/FirestoreStatus.tsx`
Debug component displaying the current Firestore project ID from env var.

---

## 5. Firestore Collections & Fields

### `Jobs` (capital J â€” consistent throughout codebase)

**Type**: `Job` (defined in `src/types/jobs.ts`)

| Field | Type | Notes |
|-------|------|-------|
| `jobName` | string | Required |
| `projectPhase` | string | ProjectPhase enum: Lead, Bidding, Opportunity, Awarded, Active, Install, Warranty, Closed, Lost |
| `gcName` | string? | Denormalized GC name |
| `gcId` | string? | ID into `companies` |
| `siteAddress` | string? | |
| `siteCity` | string? | |
| `siteState` | string? | Default "WA" |
| `siteZip` | string? | |
| `estimatorId` | string? | ID into `contacts` |
| `estimatorName` | string? | Denormalized |
| `pmId` | string? | ID into `contacts` |
| `pmName` | string? | Denormalized |
| `superintendentId` | string? | ID into `contacts` |
| `superintendentName` | string? | Denormalized |
| `jurisdictionId` | string? | ID into `jurisdictions` |
| `jurisdictionName` | string? | Denormalized |
| `originalContractValue` | number? | At time of award |
| `currentContractValue` | number? | Includes approved COs |
| `parcelNumber` | string? | Only shown for Awarded+ phases |
| `bidDueDate` | Timestamp? | Only for Lead/Bidding phases |
| `submittedDate` | Timestamp? | |
| `startDate` | Timestamp? | |
| `completionDate` | Timestamp? | |
| `createdAt` | Timestamp? | |
| `updatedAt` | Timestamp? | |
| `createdBy` | string? | User email |

**Subcollection**: `Jobs/{jobId}/activity`

**Type**: `ActivityEntry` (defined in `src/types/jobs.ts`)

| Field | Type | Notes |
|-------|------|-------|
| `text` | string | Note content |
| `tag` | string | ActivityTag: General, Bidding, Sales, PM, Field |
| `createdAt` | Timestamp | |
| `createdBy` | string | User email |
| `createdByName` | string | Display name |

---

### `changeOrders`

**Type**: `ChangeOrder` (defined in `src/types/changeOrders.ts`)

| Field | Type | Notes |
|-------|------|-------|
| `coNumber` | string | CO-01, CO-02, ... scoped per job |
| `jobId` | string | FK into `Jobs` |
| `jobNumber` | string | Denormalized |
| `jobName` | string | Denormalized |
| `subject` | string | |
| `description` | string | |
| `category` | string | COCategory: Owner Change, Field Condition, Design Error, Code Requirement, Other |
| `laborHours` | number | |
| `materialCost` | number | Raw material cost |
| `equipmentCost` | number | |
| `subcontractorCost` | number | |
| `otherCost` | number | |
| `laborBurden` | number | $/hr cost |
| `laborBillingRate` | number | $/hr billing |
| `materialMarkup` | number | % |
| `subMarkup` | number | % |
| `laborCost` | number | Computed: `laborHours Ã— laborBurden` |
| `laborBilling` | number | Computed: `laborHours Ã— laborBillingRate` |
| `laborMarkedUp` | number | (same as laborBilling â€” used in display) |
| `materialMarkedUp` | number | Computed: `materialCost Ã— (1 + materialMarkup/100)` |
| `subMarkedUp` | number | Computed: `subcontractorCost Ã— (1 + subMarkup/100)` |
| `amountRequested` | number | Total amount asked |
| `amountApproved` | number | Set on approval |
| `status` | string | COStatus: Draft, Submitted, Under Review, Approved, Rejected, Executed, Billed |
| `submittedAt` | any | Timestamp â€” typed as `any` |
| `underReviewAt` | any | Timestamp â€” typed as `any` |
| `approvedAt` | any | Timestamp â€” typed as `any` |
| `rejectedAt` | any | Timestamp â€” typed as `any` |
| `requestedBy` | string | User email |
| `requestedByName` | string | Display name |
| `approvedBy` | string? | User email |
| `approvedByName` | string? | Display name |
| `approvalDocUrl` | string? | |
| `supportingDocs` | string[] | Array of URLs |
| `internalNotes` | string? | |
| `clientNotes` | string? | |
| `rejectionReason` | string? | |
| `relatedInventoryItems` | string[]? | |
| `billedOnInvoiceId` | string? | |
| `createdAt` | any | Timestamp â€” typed as `any` |
| `updatedAt` | any | Timestamp â€” typed as `any` |

---

### `costingPhases`

**Type**: `CostingPhase` (defined in `src/types/costing.ts`)

| Field | Type | Notes |
|-------|------|-------|
| `jobId` | string | FK into `Jobs` |
| `jobName` | string | Denormalized |
| `costCode` | string | e.g. "GW", "RI", "CO-01" for COs |
| `label` | string | Human-readable label |
| `subgrouping` | string | "CONTRACTED WORK" \| "CHANGE ORDER" \| "FIXTURE" |
| `coId` | string? | FK into `changeOrders` (only for CHANGE ORDER rows) |
| `estMaterialCost` | number | |
| `estLaborCost` | number | |
| `estHours` | number | |
| `mMarkup` | number | Material markup % |
| `lMarkup` | number | Labor markup % |
| `contractValue` | number | Stored: `mCost*(1+mMarkup/100) + lCost*(1+lMarkup/100)` |
| `actualMaterials` | number? | Editable in PM view |
| `actualHours` | number? | Editable in PM view |
| `completedPct` | number? | Editable in PM view (0â€“100) |
| `notes` | string? | HTML from rich-text editor |
| `importedAt` | Timestamp | |
| `updatedAt` | Timestamp | |

---

### `estimates`

**Type**: `ServiceEstimate` (defined in `src/types/estimates.ts`)
Shared by both install and construction estimates, differentiated by the `type` field.

| Field | Type | Notes |
|-------|------|-------|
| `jobId` | string? | Optional FK into `Jobs` |
| `jobName` | string | Denormalized or free-text |
| `jobNumber` | string? | |
| `gcId` | string? | FK into `companies` |
| `gcName` | string? | Denormalized |
| `estimatorId` | string? | FK into `contacts` |
| `estimatorName` | string? | Denormalized |
| `status` | string | "Draft" \| "Opportunity" \| "Awarded" \| "Lost" |
| `type` | string? | **"install" \| "construction"** â€” absent on old docs, defaults to "install" |
| `laborRate` | number | $/hr billing (default 350 for install) |
| `laborBurden` | number | $/hr cost (default 120) |
| `materialMarkup` | number | % (default 40 for install) |
| `notes` | string? | Plain text |
| `scopeOfWork` | string? | HTML â€” construction only |
| `exclusions` | string? | HTML â€” construction only |
| `clarifications` | string? | HTML â€” construction only |
| `totalHours` | number | Rollup: sum of line hours |
| `totalLaborBilling` | number | Rollup: `totalHours Ã— laborRate` |
| `totalMaterialCost` | number | Rollup: sum of raw material costs |
| `totalContractValue` | number | Rollup: `totalLaborBilling + totalMaterialCost Ã— (1+mMarkup/100)` |
| `profitMargin` | number | Rollup: see `calcProfitMargin()` |
| `createdAt` | Timestamp | |
| `updatedAt` | Timestamp | |

---

### `estimateLines`

**Type**: `EstimateLine` (defined in `src/types/estimates.ts`)
Used by install estimates only.

| Field | Type | Notes |
|-------|------|-------|
| `estimateId` | string | FK into `estimates` |
| `costCode` | string | FK into `costCodes.code` |
| `description` | string | |
| `laborHours` | number | |
| `materialCost` | number | Raw cost (pre-markup) |
| `sortOrder` | number | |
| `createdAt` | Timestamp | |

---

### `constructionEstimatePhases`

**Type**: `ConstructionEstimatePhase` (defined in `src/types/constructionEstimate.ts`)
Phase rows for construction estimates (equivalent to `costingPhases` but pre-award).

| Field | Type | Notes |
|-------|------|-------|
| `estimateId` | string | FK into `estimates` |
| `costCode` | string | |
| `label` | string | |
| `estMaterialCost` | number | |
| `estLaborCost` | number | |
| `estHours` | number | |
| `mMarkup` | number | |
| `lMarkup` | number | |
| `contractValue` | number | |
| `sortOrder` | number | |
| `importedAt` | Timestamp | |

---

### `constructionFixtures`

**Type**: `ConstructionFixture` (defined in `src/types/constructionEstimate.ts`)

| Field | Type | Notes |
|-------|------|-------|
| `estimateId` | string | FK into `estimates` |
| `category` | string | "Fixture", "Water Heater", etc. |
| `manufacturer` | string? | |
| `model` | string? | |
| `description` | string | |
| `quantity` | number | |
| `unitCost` | number? | |
| `tag` | string? | Future submittal reference |
| `sortOrder` | number | |

---

### `companies`

**Type**: `Company` (defined in `src/types/companies.ts`)

| Field | Type | Notes |
|-------|------|-------|
| `name` | string | Required |
| `type` | string | CompanyType: GC, Sub, Vendor, Owner, Other |
| `phone` | string? | |
| `email` | string? | |
| `address` | string? | |
| `city` | string? | |
| `state` | string? | |
| `zip` | string? | |
| `website` | string? | |
| `tags` | string[]? | Freeform array; managed inline from companies list |
| `createdAt` | Timestamp? | |
| `updatedAt` | Timestamp? | |
| `createdBy` | string? | User email |

---

### `contacts`

**Type**: `Contact` (defined in `src/types/companies.ts` â€” same file as Company)

| Field | Type | Notes |
|-------|------|-------|
| `firstName` | string | Required |
| `lastName` | string | Required |
| `companyId` | string? | Optional FK into `companies` |
| `companyName` | string? | Denormalized |
| `title` | string? | |
| `phone` | string? | |
| `email` | string? | |
| `createdAt` | Timestamp? | |
| `updatedAt` | Timestamp? | |
| `createdBy` | string? | User email |

---

### `employees`

**Type**: `Employee` (defined in `src/types/employees.ts`)

| Field | Type | Notes |
|-------|------|-------|
| `firstName` | string | Required |
| `lastName` | string | Required |
| `role` | string? | Typed as `string` not `EmployeeRole` â€” see inconsistencies |
| `status` | string? | Typed as `string` not `EmployeeStatus` â€” see inconsistencies |
| `phone` | string? | |
| `email` | string? | Work email |
| `emailPersonal` | string? | |
| `homeAddress` | string? | |
| `deviceNumber` | string? | |
| `partnerName` | string? | |
| `partnerPhone` | string? | |
| `partnerEmail` | string? | |
| `emergencyContact1` | string? | Name |
| `emergency1Phone` | string? | |
| `emergencyContact2` | string? | Name |
| `emergency2Phone` | string? | |
| `birthday` | string? | YYYY-MM-DD |
| `hireDate` | string? | YYYY-MM-DD |
| `licenseId` | string? | |
| `licPlumbing` | string? | |
| `expPlumbing` | string? | YYYY-MM-DD |
| `licScissorLift` | string? | YYYY-MM-DD |
| `expGas` | string? | YYYY-MM-DD |
| `licGas` | string? | |
| `createdAt` | Timestamp? | |
| `updatedAt` | Timestamp? | |
| `createdBy` | string? | |

---

### `jurisdictions`

**Type**: `Jurisdiction` (defined in `src/types/jurisdictions.ts`)

| Field | Type | Notes |
|-------|------|-------|
| `name` | string | Required |
| `state` | string? | |
| `phone` | string? | |
| `inspectionPhone` | string? | |
| `address` | string? | |
| `website` | string? | |
| `notes` | string? | |
| `contactIds` | string[]? | Array of IDs into `contacts` |
| `contactNames` | string? | **LEGACY**: comma-separated names (pre-contactIds) |
| `createdAt` | Timestamp? | |
| `updatedAt` | Timestamp? | |
| `createdBy` | string? | |

---

### `costCodes`

**Type**: `CostCode` (defined in `src/types/costCodes.ts`)

| Field | Type | Notes |
|-------|------|-------|
| `code` | string | Uppercase abbreviation e.g. "GW", "LEAK" |
| `label` | string | Human-readable e.g. "Groundwork" |
| `sortOrder` | number | Controls display ordering |

**Seed data** (12 codes): GW (Groundwork), RI (Rough In), TRM (Trim), WH (Water Heater), GAS (Gas Piping), FIX (Fixture Cost), MISC01 (Miscellaneous), LEAK (Leak Repair), DRAIN (Drain Service), RPR (Repair), INSP (Inspection), INST (Installation).

---

### `files`

**Type**: `AppFile` (defined in `src/types/files.ts`)

| Field | Type | Notes |
|-------|------|-------|
| `name` | string | Original filename |
| `storagePath` | string | Firebase Storage path for `deleteObject()` |
| `downloadUrl` | string | From `getDownloadURL()` |
| `size` | number | Bytes |
| `contentType` | string | MIME type |
| `entityType` | string | FileEntity: "job" \| "employee" \| "other" |
| `entityId` | string | ID of linked entity |
| `entityName` | string? | Denormalized name |
| `category` | string? | JobFileCategory â€” only set when `entityType === "job"` |
| `uploadedBy` | string | User email |
| `uploadedAt` | Timestamp | |

**Storage path pattern**: `{entityType}/{entityId}/{category}/{filename}`

---

## 6. TypeScript Types & Interfaces

### `src/types/jobs.ts`
```
type ProjectPhase = "Lead" | "Bidding" | "Opportunity" | "Awarded" | "Active" | "Install" | "Warranty" | "Closed" | "Lost"
const PROJECT_PHASES: ProjectPhase[]
const PHASE_BADGE_CLASS: Record<ProjectPhase, string>
interface Job { ... }
type ActivityTag = "General" | "Bidding" | "Sales" | "PM" | "Field"
const ACTIVITY_TAGS: ActivityTag[]
interface ActivityEntry { id, text, createdAt, createdBy, createdByName, tag }
```

### `src/types/companies.ts`
```
type CompanyType = "GC" | "Sub" | "Vendor" | "Owner" | "Other"
const COMPANY_TYPES: CompanyType[]
const COMPANY_TYPE_LABEL: Record<CompanyType, string>   // "Owner" displays as "Business"
const COMPANY_TYPE_BADGE: Record<CompanyType, string>
interface Company { ... }
interface Contact { ... }
function contactDisplayName(c): string
```

### `src/types/changeOrders.ts`
```
type COCategory = "Owner Change" | "Field Condition" | "Design Error" | "Code Requirement" | "Other"
type COStatus = "Draft" | "Submitted" | "Under Review" | "Approved" | "Rejected" | "Executed" | "Billed"
const MATERIAL_MARKUP_TIERS  // [ {maxCost, label, suggested}, ... ]
function suggestMaterialMarkup(materialCost: number): number
const LABOR_RATE_TIERS       // [ {maxHours, label, suggested}, ... ]
function suggestLaborRate(hours: number): number
interface ChangeOrder { ... }
```

### `src/types/costing.ts`
```
interface CostingPhase { ... }
const COST_CODE_LABELS: Record<string, string>  // Only 6 codes (see inconsistencies)
function calcContractValue(mCost, lCost, mMarkup, lMarkup): number
function calcBillable(contractValue, pct?): number
interface ParsedPhaseRow { costCode, label, estMaterialCost, estLaborCost, estHours, mMarkup, lMarkup, contractValue }
function parseBudgetTSV(text, labelMap?): ParsedPhaseRow[]
```

### `src/types/estimates.ts`
```
interface ServiceEstimate { ... }
interface EstimateLine { ... }
function calcProfitMargin(totalHours, totalLaborBilling, totalMaterialCost, laborBurden, materialMarkup): number
function calcEstimateRollup(lines, laborRate, laborBurden, materialMarkup): rollup object
```

### `src/types/constructionEstimate.ts`
```
interface ConstructionEstimatePhase { ... }
interface ConstructionFixture { ... }
function calcConstructionRollup(phases): { totalContractValue, totalHours, totalMaterialCost, totalLaborCost }
interface ParsedFixtureRow { category, manufacturer, model, description, quantity, unitCost, tag }
function parseFixtureTSV(text): ParsedFixtureRow[]
```

### `src/types/employees.ts`
```
type EmployeeRole = "Owner" | "Journeyman" | "Apprentice" | "Admin" | "BookKeeper"
const EMPLOYEE_ROLES: EmployeeRole[]
const EMPLOYEE_ROLE_BADGE: Record<EmployeeRole, string>
const EMPLOYEE_STATUS = ["Employed", "Terminated"] as const
type EmployeeStatus = "Employed" | "Terminated"
interface Employee { ... }
function employeeDisplayName(e): string
```

### `src/types/jurisdictions.ts`
```
interface Jurisdiction { ... }
```

### `src/types/costCodes.ts`
```
interface CostCode { id, code, label, sortOrder }
const SEED_COST_CODES: Omit<CostCode, "id">[]   // 12 codes
```

### `src/types/files.ts`
```
type FileEntity = "job" | "employee" | "other"
type JobFileCategory = "Schedule" | "Workbook" | "Contract/Bid" | "Permits" | "Bid Plans" | "Active Plans" | "Health Plans" | "Fix/Equip (Others)" | "Fix/Equip (PS)" | "COI Doc" | "Site Safety Doc" | "Lien Intent" | "Pictures" | "Close Out Docs"
const JOB_FILE_CATEGORIES: JobFileCategory[]
type JobFilePhase = "Bidding" | "Awarded" | "Active" | "Close out"
const JOB_FILE_PHASES: JobFilePhase[]
const CATEGORIES_BY_PHASE: Record<JobFilePhase, JobFileCategory[]>
function defaultFilePhaseForJob(projectPhase): JobFilePhase
interface AppFile { ... }
function formatBytes(bytes): string
```

---

## 7. Library Files & Utilities

### `src/lib/firebase.ts`
Firebase client initialization. Exports:
- `app: FirebaseApp`
- `auth: Auth` (via `getAuth(app)`)
- `db: Firestore` (via `getFirestore(app)`)
- `storage: FirebaseStorage` (via `getStorage(app)`)
- `isFirebaseConfigured(): boolean`
- `getFirebaseApp()`, `getFirebaseAuth()`, `getFirestoreDb()`, `getFirebaseStorage()`
- `getFirebaseAnalytics(): Promise<Analytics | undefined>` (browser-only, optional)

Required env vars: `NEXT_PUBLIC_FIREBASE_API_KEY`, `NEXT_PUBLIC_FIREBASE_AUTH_DOMAIN`, `NEXT_PUBLIC_FIREBASE_PROJECT_ID`, `NEXT_PUBLIC_FIREBASE_APP_ID`, `NEXT_PUBLIC_FIREBASE_STORAGE_BUCKET`, `NEXT_PUBLIC_FIREBASE_MESSAGING_SENDER_ID`.
Optional: `NEXT_PUBLIC_FIREBASE_MEASUREMENT_ID`.

### `src/lib/firestore.ts`
Generic Firestore helpers (thin wrappers). Re-exports common Firestore functions. Exports:
- `getDb(): Firestore`
- `getCollection<T>(path, ...segments): CollectionReference<T>`
- `getDocRef(path, ...segments): DocumentReference`
- `fetchCollection<T>(collectionPath, constraints?): Promise<T[]>`
- `fetchDoc<T>(collectionPath, docId): Promise<T | null>`
- `createDoc<T>(collectionPath, data): Promise<string>` â€” adds `createdAt` + `updatedAt`
- `updateDocTimestamp(collectionPath, docId, data): Promise<void>` â€” adds `updatedAt`
- `removeDoc(collectionPath, docId): Promise<void>`

**Note**: These helpers are defined but appear to be rarely used by the application pages/components, which mostly call Firestore functions directly.

### `src/lib/format.ts`
Phone number formatting utilities:
- `formatPhoneDisplay(phone): string` â€” formats to `XXX-XXX-XXXX` or `1-XXX-XXX-XXXX`
- `formatPhoneTel(phone): string` â€” returns digits only for `tel:` href

---

## 8. Flagged Inconsistencies & Bugs

### ðŸ”´ CRITICAL

None found that would completely break functionality with the current data.

### ðŸŸ¡ SIGNIFICANT

**1. `COStatus` type defined twice**
`type COStatus` is properly exported from `src/types/changeOrders.ts`, but `src/app/change-orders/page.tsx` redefines it locally as an identical inline type alias instead of importing from types. If the canonical type ever changes, the local copy in the page won't stay in sync.

**2. `@anthropic-ai/sdk` installed but unused**
`package.json` lists `@anthropic-ai/sdk: ^0.75.0` as a dependency, but `src/app/api/enhance-description/route.ts` calls the Anthropic API directly via `fetch()` with hardcoded URL `https://api.anthropic.com/v1/messages`. The SDK is never imported anywhere. This means extra bundle weight and a potential mismatch if the API version drifts. Either use the SDK or remove it from `package.json`.

**3. `COST_CODE_LABELS` in `src/types/costing.ts` only has 6 codes; `SEED_COST_CODES` has 12**
`parseBudgetTSV()` uses `COST_CODE_LABELS` as the default `labelMap` when none is provided. This means the 6 service codes (MISC01, LEAK, DRAIN, RPR, INSP, INST) would display as their raw code strings when `parseBudgetTSV` is called without a `labelMap`. In practice, `BudgetImport.tsx` passes a live labelMap from Firestore so this is mitigated for that component, but any other call to `parseBudgetTSV` without a labelMap will produce incomplete labels.

**4. Debug `console.log` left in `ChangeOrderForm.tsx`**
Line 191: `console.log("collection ref:", collection(db, "Jobs"));` â€” this fires on every job search query.

### ðŸŸ  MINOR / MAINTENANCE

**5. `Employee.role` and `Employee.status` typed as `string` in the interface**
The `EmployeeRole` and `EmployeeStatus` types exist and are used in the UI, but the `Employee` interface itself types these fields as `string?` rather than `EmployeeRole?` and `EmployeeStatus?`. This loses type safety at the data layer.

**6. `ChangeOrder` timestamp fields typed as `any`**
`submittedAt`, `underReviewAt`, `approvedAt`, `rejectedAt`, `createdAt`, `updatedAt` in the `ChangeOrder` interface are all typed as `any`. They should be `Timestamp | null`.

**7. `Jurisdiction.contactNames` legacy field still in type**
The field is documented in the comment as "legacy: comma-separated display names (pre-link)" and was superseded by `contactIds`. No code currently writes to `contactNames`, but old Firestore documents still have it. Low priority but should eventually be migrated and the field removed from the type.

**8. `ServiceEstimate.type` is optional; existing docs may not have it**
The `type` field (`"install" | "construction"`) was added after the initial estimates were created. Code uses `est.type ?? "install"` as a fallback, which is correct. But the Firestore documents for old estimates will not have this field, so any query filtering on `type` would miss them.

**9. `src/lib/firestore.ts` helper functions are barely used**
The file defines `fetchCollection`, `fetchDoc`, `createDoc`, `updateDocTimestamp`, `removeDoc` as convenience wrappers, but every component and page accesses Firestore directly using the Firebase SDK calls. The helpers serve mainly as a re-export module and provide little practical abstraction. Consider either adopting them consistently or removing the wrappers.

**10. `Contact` and `Company` interfaces defined in the same file (`src/types/companies.ts`)**
These are logically separate entities (companies = orgs, contacts = people) but share a type file. Minor organizational issue.

**11. `Opportunity` in `ProjectPhase` vs. `ServiceEstimate.status`**
Both use "Opportunity" as a status value but in different contexts. The `Job.projectPhase` can be "Opportunity" and `ServiceEstimate.status` can be "Opportunity". These are separate concepts (estimate status vs. job pipeline stage) but the same word, which could cause confusion.

**12. `import/page.tsx` has 1500+ lines of hardcoded data**
The Airtable import page contains all historical contact, company, jurisdiction, and employee data as hardcoded arrays. This file is likely only run once per environment and should be archived or removed after migration is complete to avoid confusion.

---

## 9. Foreign Key Relationships

### Dominant Pattern

The codebase uses a consistent **ID + denormalized name** pattern for almost all relationships. When entity A references entity B, the doc stores both `bId` (Firestore document ID) and `bName` (a copy of the display name). This avoids extra reads at display time but means names can go stale if the referenced document is renamed.

Example: a Job stores `gcId` (company document ID) + `gcName` ("ABC Construction") so the job page can display the GC name without fetching the company.

---

### Relationship 1: contacts â†’ companies
| | |
|---|---|
| **Fields written** | `contacts.companyId` (string, Firestore ID) + `contacts.companyName` (string, denormalized) |
| **Pattern** | ID + Name |
| **Forward (write) paths** | `ContactForm.tsx`: CompanyPicker sets both. `companies/[id]/page.tsx` inline "Add Contact" form: hardcodes `companyId: id`, `companyName: company.name`. |
| **Reverse lookup** | `companies/[id]/page.tsx`: queries `collection(db, "contacts") where("companyId", "==", id)` |
| **Stale risk** | If a company is renamed, existing contacts retain the old `companyName`. No update propagation code exists. |
| **Inconsistency** | None â€” pattern is consistent with the rest of the codebase. |

---

### Relationship 2: Jobs â†’ companies (GC)
| | |
|---|---|
| **Fields written** | `Jobs.gcId` (string, optional) + `Jobs.gcName` (string, optional) |
| **Pattern** | ID + Name |
| **Forward (write) paths** | `JobForm.tsx`: `<select>` dropdown of all companies (GCs listed first). `EstimateBuilder.tsx` handleMarkAwarded creates new Jobs and carries `gcId`/`gcName` from estimate. |
| **Reverse lookup** | **None.** No page queries "Jobs where gcId == X". |
| **Stale risk** | If a GC is renamed, all linked jobs retain the old `gcName`. |
| **Inconsistency** | None in the field pattern. However, `JobForm` shows all companies (filtered by `type === "GC"` first, then "Other Companies") while `EstimateBuilder` GC typeahead searches all `companies` without type filtering. |

---

### Relationship 3: Jobs â†’ jurisdictions
| | |
|---|---|
| **Fields written** | `Jobs.jurisdictionId` (string, optional) + `Jobs.jurisdictionName` (string, optional) |
| **Pattern** | ID + Name |
| **Forward (write) paths** | `JobForm.tsx`: `<select>` dropdown of all jurisdictions. |
| **Reverse lookup** | **None.** No page queries jobs by jurisdiction. |
| **Stale risk** | Jurisdiction renames not propagated. |
| **Inconsistency** | None. |

---

### Relationship 4: Jobs â†’ contacts (team members)
| | |
|---|---|
| **Fields written** | Three ID+Name pairs: `estimatorId`/`estimatorName`, `pmId`/`pmName`, `superintendentId`/`superintendentName` |
| **Pattern** | ID + Name (Ã— 3 roles) |
| **Forward (write) paths** | `JobForm.tsx` via three `ContactPicker` components. `EstimateBuilder.tsx` handleMarkAwarded carries `estimatorId`/`estimatorName` from the estimate to the auto-created Job. |
| **Reverse lookup** | `jobs/[id]/page.tsx`: team member IDs are clickable and open `ContactDetailModal`. No reverse query (no page shows "jobs for contact X"). |
| **Important** | These link to the `contacts` collection (external people). Not linked to `employees` collection (internal staff). |
| **Inconsistency** | None in pattern. Semantic note: PM and superintendent are internal roles but reference external `contacts`, not `employees`. |

---

### Relationship 5: changeOrders â†’ Jobs âš 
| | |
|---|---|
| **Fields written** | `changeOrders.jobId` (string) + `changeOrders.jobName` (string) + `changeOrders.jobNumber` (string) |
| **Pattern** | ID + Name **+ jobNumber** â€” three fields (unique in codebase) |
| **Forward (write) paths** | `ChangeOrderForm.tsx` and `FieldChangeOrderForm.tsx`: both query `Jobs where projectPhase in ["Active","Awarded"]` to populate dropdown. On select, write all three fields. |
| **Reverse lookup** | `jobs/[id]/page.tsx`: queries `changeOrders where("jobId", "==", id)` |
| **INCONSISTENCY 1** | `jobNumber` is read from Firestore Jobs documents (`d.jobNumber as string`) in both CO forms, but `jobNumber` is **not declared in the `Job` TypeScript interface**. This is an undocumented runtime field â€” if it's missing on a Job doc, it silently falls back to `""`. |
| **INCONSISTENCY 2** | `ChangeOrder` interface declares `jobNumber: string` (required, non-optional) but the source field on `Job` is undeclared. TypeScript can't catch mismatches here. |
| **Race condition** | CO number (`CO-01`, `CO-02`, â€¦) is generated by counting existing COs for the job then writing: `existingSnap.size + 1`. Two simultaneous CO submissions for the same job can produce the same number. |

---

### Relationship 6: costingPhases â†’ Jobs
| | |
|---|---|
| **Fields written** | `costingPhases.jobId` (string) + `costingPhases.jobName` (string) |
| **Pattern** | ID + Name |
| **Forward (write) paths** | **Three distinct paths:**  (1) `BudgetImport.tsx`: receives `jobId`/`jobName` as props, writes both on import.  (2) `EstimateBuilder.tsx` `handleMarkAwarded`: groups estimate lines by costCode, creates one `costingPhase` per code with the job's ID and name.  (3) `ChangeOrderReview.tsx` `handleApprove`: reads `co.jobId`/`co.jobName` from the change order doc, writes them to a new or updated `costingPhase` with `subgrouping: "CHANGE ORDER"`. |
| **Reverse lookup** | `jobs/[id]/page.tsx`: queries `costingPhases where("jobId", "==", id)`. `project-management/page.tsx`: queries all `costingPhases`, groups by `jobId`. |
| **Inconsistency** | None in pattern. Note that `ChangeOrderReview` reads `co.jobId` and `co.jobName` off the changeOrder doc and re-stores them on costingPhases â€” a two-hop denormalization chain. |

---

### Relationship 7: costingPhases â†’ changeOrders âš 
| | |
|---|---|
| **Fields written** | `costingPhases.coId` (string, present only when `subgrouping === "CHANGE ORDER"`) |
| **Pattern** | **ID only** â€” no companion name field |
| **Forward (write) paths** | `ChangeOrderReview.tsx` `handleApprove`: queries `costingPhases where coId == coId`; upserts with `coId: coId`. |
| **Reverse lookup** | Same component queries `costingPhases where("coId", "==", coId)` to find the existing phase to update, rather than creating a duplicate. |
| **INCONSISTENCY** | This is the **only FK in the codebase that stores an ID without a denormalized name**. All other FKs store both. The coNumber is instead stored on `costingPhases.costCode` (the CO number like "CO-01" is used as the costCode for CHANGE ORDER phases), and `costingPhases.label` holds the CO subject. So the name isn't lost, it's just stored differently. |

---

### Relationship 8: estimateLines â†’ estimates
| | |
|---|---|
| **Fields written** | `estimateLines.estimateId` (string) |
| **Pattern** | ID only â€” **intentional** for parent-child pattern |
| **Forward (write) paths** | `EstimateBuilder.tsx` `handleAddLine`: writes `estimateId` on every new line. |
| **Reverse lookup** | `EstimateBuilder.tsx` load: queries `estimateLines where("estimateId", "==", estimateId)`. Delete estimate also: queries same to find all lines to delete. |
| **Inconsistency** | None â€” ID-only is appropriate for a strict parent-child collection. |

---

### Relationship 9: estimates â†’ Jobs (optional)
| | |
|---|---|
| **Fields written** | `estimates.jobId` (string \| null, optional) + `estimates.jobName` (string, optional) |
| **Pattern** | ID + Name (optional) |
| **Forward (write) paths** | `EstimateBuilder.tsx`: typeahead on Job Name field. User can link or unlink. If no job is linked when "Mark Awarded" is clicked, a new Job is auto-created and the link is set. |
| **Reverse lookup** | **None.** No page queries estimates by jobId. |
| **INCONSISTENCY** | `handleMarkOpportunity` in `EstimateBuilder.tsx` (line 513) calls `updateDoc(doc(db, "jobs", jobId), ...)` â€” **lowercase "jobs"** instead of the correct **"Jobs"** (capital J). This is a **bug**: when an estimate is marked Opportunity, the linked job's phase is silently **not updated** because the wrong collection path is written to (Firestore doesn't throw for a non-existent path in this context). |

---

### Relationship 10: estimates â†’ companies (GC, optional)
| | |
|---|---|
| **Fields written** | `estimates.gcId` (string \| null, optional) + `estimates.gcName` (string \| null, optional) |
| **Pattern** | ID + Name (optional) |
| **Forward (write) paths** | `EstimateBuilder.tsx` GC typeahead â€” searches all `companies` by name. |
| **Reverse lookup** | None. |
| **Note** | When a job is selected from the typeahead, the GC fields are auto-populated from the job's `gcId`/`gcName`. |

---

### Relationship 11: estimates â†’ contacts (estimator, optional)
| | |
|---|---|
| **Fields written** | `estimates.estimatorId` (string \| null, optional) + `estimates.estimatorName` (string \| null, optional) |
| **Pattern** | ID + Name (optional) |
| **Forward (write) paths** | `EstimateBuilder.tsx` estimator typeahead â€” searches `contacts` by name, title, and company. Same auto-populate behavior when a job is selected. |
| **Reverse lookup** | None. |

---

### Relationship 12: jurisdictions â†’ contacts (array FK) âš 
| | |
|---|---|
| **Fields written** | `jurisdictions.contactIds` (string[], optional) â€” array of contact document IDs |
| **Legacy field** | `jurisdictions.contactNames` (string, optional) â€” comma-separated display names, superseded |
| **Pattern** | **Array of IDs** â€” no denormalized names stored alongside |
| **Forward (write) paths** | `JurisdictionForm.tsx` via `ContactMultiPicker` component, which writes the full array of selected contact IDs. |
| **Reverse lookup** | `jurisdictions/[id]/page.tsx`: queries `contacts where("__name__", "in", chunk)` in chunks of 30 (Firestore `in` limit) to resolve the IDs to Contact objects. Contacts do **not** store a `jurisdictionId` back-reference. |
| **INCONSISTENCY 1** | This is the only relationship using an **array FK** pattern. All other FKs are scalar (single ID + name on the child side). |
| **INCONSISTENCY 2** | No denormalized names stored alongside the IDs, unlike every other FK relationship. The display page must always fetch live. |
| **INCONSISTENCY 3** | Two fields (`contactIds` array and legacy `contactNames` string) exist simultaneously on the same document. Old docs may only have `contactNames`. The detail page renders `contactNames` as fallback when `contactIds` is empty/absent. |

---

### Relationship 13: files â†’ any entity (polymorphic)
| | |
|---|---|
| **Fields written** | `files.entityType` (string) + `files.entityId` (string) |
| **Pattern** | Polymorphic â€” `entityType` disambiguates which collection `entityId` belongs to |
| **Forward (write) paths** | `FileUpload.tsx`: accepts `entityType` and `entityId` as props. |
| **Reverse lookup** | `FileList.tsx`/`files/page.tsx`: queries `files where("entityType", "==", type) where("entityId", "==", id)`. |
| **INCONSISTENCY** | `entityType` is a runtime string with no TypeScript enum or union constraining its values. If `entityType = "job"`, the `entityId` should reference the `"Jobs"` collection (capital J) â€” but this is unenforced. No validation layer exists. |

---

### Relationship 14: Jobs/{id}/activity (subcollection)
| | |
|---|---|
| **Storage** | Subcollection at `Jobs/{jobId}/activity/{activityId}` |
| **Pattern** | **Subcollection** â€” the only subcollection in the codebase |
| **Write paths** | `jobs/[id]/page.tsx`: `addDoc(collection(db, "Jobs", id, "activity"), ...)` â€” written when notes are edited. |
| **Read paths** | Same page: `collection(db, "Jobs", id, "activity")` |
| **INCONSISTENCY** | All other "child" data (costingPhases, changeOrders, estimateLines) use **flat collections with a parent ID field**. Only activity uses the subcollection pattern. This makes cross-job activity queries impossible (you can't query all activity across all jobs). |

---

### Cross-Cutting: User Identity Fields âš 

Different parts of the codebase store different representations of the authenticated user:

| Location | Field | Value stored |
|----------|-------|-------------|
| `contacts.createdBy` | email string | `auth.currentUser.email` |
| `Jobs.createdBy` | email string | prop passed from page (email) |
| `changeOrders.requestedBy` | **UID string** | `user.uid` |
| `changeOrders.requestedByName` | display name string | `user.displayName ?? user.email` |
| `changeOrders.approvedBy` | **UID string** | `user.uid` |
| `changeOrders.approvedByName` | display name string | `user.displayName ?? user.email ?? ""` |

**Inconsistency**: All `createdBy` fields store email. All change order actor fields (`requestedBy`, `approvedBy`) store UID. These cannot be joined without a lookup. The display-safe name is stored alongside the UID for CO fields but not alongside email for `createdBy` fields.

---

### Summary of FK Inconsistencies (Prioritized)

| # | Issue | Severity | Location |
|---|-------|----------|----------|
| 1 | **BUG: lowercase "jobs"** in `handleMarkOpportunity` | ðŸ”´ High | `EstimateBuilder.tsx:513` |
| 2 | **`jobNumber` undeclared on `Job` type** but read/written in CO forms | ðŸŸ  Medium | `ChangeOrderForm.tsx`, `FieldChangeOrderForm.tsx`, `Job` interface |
| 3 | **User identity split**: `createdBy` = email vs. CO actor fields = UID | ðŸŸ  Medium | All collections |
| 4 | **`costingPhases.coId` has no companion name** (only FK without denormalized name) | ðŸŸ¡ Low | `ChangeOrderReview.tsx` |
| 5 | **Jurisdiction `contactIds[]` array FK** vs. scalar ID+Name everywhere else | ðŸŸ¡ Low | `JurisdictionForm.tsx`, `jurisdictions/[id]/page.tsx` |
| 6 | **Legacy `contactNames` string** coexists with `contactIds[]` array | ðŸŸ¡ Low | `jurisdictions` collection, `Jurisdiction` type |
| 7 | **`files.entityType` runtime string** not validated against actual collection names | ðŸŸ¡ Low | `FileUpload.tsx`, `files` collection |
| 8 | **`Jobs/activity` subcollection** vs. flat collection pattern everywhere else | ðŸŸ¡ Low | `jobs/[id]/page.tsx` |
| 9 | **CO number race condition**: count-then-write generates CO numbers | ðŸŸ¡ Low | `ChangeOrderForm.tsx`, `FieldChangeOrderForm.tsx` |
| 10 | **No reverse lookups** from company â†’ jobs or contact â†’ jobs | â„¹ï¸ Info | Architecture |

---

## Quick Reference: Which Components Write to Which Collections

| Component / Page | Reads | Writes |
|------------------|-------|--------|
| `JobForm` | `companies`, `jurisdictions` | `Jobs` |
| `jobs/[id]/page` | `Jobs`, `costingPhases`, `files` | `Jobs/{id}/activity` |
| `EstimateBuilder` | `estimates`, `estimateLines`, `costCodes`, `Jobs`, `companies`, `contacts` | `estimates`, `estimateLines`, `costingPhases`, `Jobs` |
| `ConstructionEstimateBuilder` | `estimates`, `constructionEstimatePhases`, `constructionFixtures`, `Jobs`, `companies`, `contacts` | `estimates`, `constructionEstimatePhases`, `constructionFixtures` |
| `ChangeOrderForm` | `Jobs`, `changeOrders` | `changeOrders` |
| `FieldChangeOrderForm` | `Jobs`, `changeOrders` | `changeOrders` |
| `ChangeOrderReview` | `changeOrders`, `costingPhases` | `changeOrders`, `costingPhases` |
| `BudgetImport` | `costCodes`, `costingPhases` | `costingPhases` (full replace) |
| `project-management/page` | `Jobs`, `costingPhases` | `costingPhases` |
| `ContactForm` | â€” | `contacts` |
| `CompanyForm` | â€” | `companies` |
| `JurisdictionForm` | â€” | `jurisdictions` |
| `EmployeeForm` | â€” | `employees` |
| `FileUpload` | â€” | Firebase Storage, `files` |
| `FileList` | `files` | (deletes `files` + Storage from `/files` page) |
| `settings/page` | `costCodes` | `costCodes` |
| `import/page` | `companies`, `contacts`, `Jobs`, `jurisdictions`, `employees` | `companies`, `contacts`, `Jobs`, `jurisdictions`, `employees` |

{
  "version": 3,
  "sources": [],
  "sections": [
    {"offset": {"line": 46, "column": 0}, "map": {"version":3,"sources":["file:///C:/Users/NathanParker/SynologyDrive/parker-bos/src/app/api/enhance-description/route.ts"],"sourcesContent":["import { NextResponse } from \"next/server\";\nimport Anthropic from \"@anthropic-ai/sdk\";\n\nconst systemPrompt = `You are helping a construction field technician write a clear change order description. The user will provide a brief note or bullet points from the field. Your job is to turn it into a professional, factual change order description suitable for client and internal review.\n\nRules:\n- Use full sentences and clear language.\n- Do not invent details, quantities, or scope that are not implied by the input.\n- Keep the same meaning and facts; only improve clarity and structure.\n- Output only the enhanced description text, no preamble or labels.`;\n\nexport async function POST(request: Request) {\n  const apiKey = process.env.ANTHROPIC_API_KEY;\n  if (!apiKey) {\n    return NextResponse.json(\n      { error: \"Enhancement is not configured (missing API key).\" },\n      { status: 503 }\n    );\n  }\n\n  let body: {\n    description?: string;\n    subject?: string;\n    category?: string;\n    jobName?: string;\n  };\n  try {\n    body = await request.json();\n  } catch {\n    return NextResponse.json(\n      { error: \"Invalid JSON body.\" },\n      { status: 400 }\n    );\n  }\n\n  const description = typeof body.description === \"string\" ? body.description.trim() : \"\";\n  const subject = typeof body.subject === \"string\" ? body.subject.trim() : \"\";\n  const category = typeof body.category === \"string\" ? body.category.trim() : \"\";\n  const jobName = typeof body.jobName === \"string\" ? body.jobName.trim() : \"\";\n\n  if (!description) {\n    return NextResponse.json(\n      { error: \"Description is required.\" },\n      { status: 400 }\n    );\n  }\n\n  const contextParts: string[] = [];\n  if (subject) contextParts.push(`Subject: ${subject}`);\n  if (category) contextParts.push(`Category: ${category}`);\n  if (jobName) contextParts.push(`Job: ${jobName}`);\n  const contextBlock =\n    contextParts.length > 0\n      ? `\\nContext:\\n${contextParts.join(\"\\n\")}\\n`\n      : \"\";\n\n  const userMessage = `${contextBlock}Brief description from the field:\\n\\n${description}`;\n\n  const client = new Anthropic({ apiKey });\n  try {\n    const message = await client.messages.create({\n      model: \"claude-sonnet-4-5-20250929\",\n      max_tokens: 500,\n      system: systemPrompt,\n      messages: [{ role: \"user\", content: userMessage }],\n    });\n\n    const textBlock = message.content.find(\n      (b): b is { type: \"text\"; text: string } => b.type === \"text\"\n    );\n    const content = textBlock?.text?.trim();\n    if (!content) {\n      return NextResponse.json(\n        { error: \"No enhanced text returned.\" },\n        { status: 502 }\n      );\n    }\n\n    return NextResponse.json({ enhanced: content });\n  } catch (err) {\n    console.error(\"[enhance-description]\", err);\n    const message = err instanceof Error ? err.message : \"Enhancement failed.\";\n    return NextResponse.json(\n      { error: message },\n      { status: 500 }\n    );\n  }\n}\n"],"names":[],"mappings":";;;;AAAA;AACA;AAAA;;;AAEA,MAAM,eAAe,CAAC;;;;;;mEAM6C,CAAC;AAE7D,eAAe,KAAK,OAAgB;IACzC,MAAM,SAAS,QAAQ,GAAG,CAAC,iBAAiB;IAC5C,IAAI,CAAC,QAAQ;QACX,OAAO,+PAAY,CAAC,IAAI,CACtB;YAAE,OAAO;QAAmD,GAC5D;YAAE,QAAQ;QAAI;IAElB;IAEA,IAAI;IAMJ,IAAI;QACF,OAAO,MAAM,QAAQ,IAAI;IAC3B,EAAE,OAAM;QACN,OAAO,+PAAY,CAAC,IAAI,CACtB;YAAE,OAAO;QAAqB,GAC9B;YAAE,QAAQ;QAAI;IAElB;IAEA,MAAM,cAAc,OAAO,KAAK,WAAW,KAAK,WAAW,KAAK,WAAW,CAAC,IAAI,KAAK;IACrF,MAAM,UAAU,OAAO,KAAK,OAAO,KAAK,WAAW,KAAK,OAAO,CAAC,IAAI,KAAK;IACzE,MAAM,WAAW,OAAO,KAAK,QAAQ,KAAK,WAAW,KAAK,QAAQ,CAAC,IAAI,KAAK;IAC5E,MAAM,UAAU,OAAO,KAAK,OAAO,KAAK,WAAW,KAAK,OAAO,CAAC,IAAI,KAAK;IAEzE,IAAI,CAAC,aAAa;QAChB,OAAO,+PAAY,CAAC,IAAI,CACtB;YAAE,OAAO;QAA2B,GACpC;YAAE,QAAQ;QAAI;IAElB;IAEA,MAAM,eAAyB,EAAE;IACjC,IAAI,SAAS,aAAa,IAAI,CAAC,CAAC,SAAS,EAAE,SAAS;IACpD,IAAI,UAAU,aAAa,IAAI,CAAC,CAAC,UAAU,EAAE,UAAU;IACvD,IAAI,SAAS,aAAa,IAAI,CAAC,CAAC,KAAK,EAAE,SAAS;IAChD,MAAM,eACJ,aAAa,MAAM,GAAG,IAClB,CAAC,YAAY,EAAE,aAAa,IAAI,CAAC,MAAM,EAAE,CAAC,GAC1C;IAEN,MAAM,cAAc,GAAG,aAAa,qCAAqC,EAAE,aAAa;IAExF,MAAM,SAAS,IAAI,iSAAS,CAAC;QAAE;IAAO;IACtC,IAAI;QACF,MAAM,UAAU,MAAM,OAAO,QAAQ,CAAC,MAAM,CAAC;YAC3C,OAAO;YACP,YAAY;YACZ,QAAQ;YACR,UAAU;gBAAC;oBAAE,MAAM;oBAAQ,SAAS;gBAAY;aAAE;QACpD;QAEA,MAAM,YAAY,QAAQ,OAAO,CAAC,IAAI,CACpC,CAAC,IAA2C,EAAE,IAAI,KAAK;QAEzD,MAAM,UAAU,WAAW,MAAM;QACjC,IAAI,CAAC,SAAS;YACZ,OAAO,+PAAY,CAAC,IAAI,CACtB;gBAAE,OAAO;YAA6B,GACtC;gBAAE,QAAQ;YAAI;QAElB;QAEA,OAAO,+PAAY,CAAC,IAAI,CAAC;YAAE,UAAU;QAAQ;IAC/C,EAAE,OAAO,KAAK;QACZ,QAAQ,KAAK,CAAC,yBAAyB;QACvC,MAAM,UAAU,eAAe,QAAQ,IAAI,OAAO,GAAG;QACrD,OAAO,+PAAY,CAAC,IAAI,CACtB;YAAE,OAAO;QAAQ,GACjB;YAAE,QAAQ;QAAI;IAElB;AACF"}}]
}